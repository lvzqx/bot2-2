name: Discord Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'  # 5分ごとにチェック

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    # 同じコミットに対して同時に複数のワークフローが実行されないようにする
    concurrency: 
      group: bot-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Setup database directory
      run: |
        mkdir -p logs temp backups
        chmod 755 logs temp backups
    
    - name: Check if bot is running
      id: check_bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_IDS }}
      run: |
        # 既存の実行中のワークフローをチェック
        RUNNING_JOBS=$(curl -s -H "Authorization: token ${{ github.token }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?status=in_progress" | \
          jq -r '.workflow_runs[] | select(.id != ${{ github.run_id }}) | .id')
        
        if [ -z "$RUNNING_JOBS" ]; then
          echo "ボットが実行されていないため、起動します"
          echo "RUN_BOT=true" >> $GITHUB_ENV
        else
          echo "ボットは既に実行中です"
          echo "RUN_BOT=false" >> $GITHUB_ENV
        fi
    
    - name: Run bot
      if: env.RUN_BOT == 'true'
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        ALLOWED_CHANNEL_IDS: ${{ secrets.ALLOWED_CHANNEL_IDS }}
      run: |
        # 既存のプロセスを終了
        pkill -f "python.*bot.py" || true
        
        # ボットを起動
        export DB_PATH="bot.db"
        nohup python bot.py > logs/bot.log 2>&1 &
        echo $! > temp/bot.pid
        
        # 起動を待つ
        sleep 10
        
        # ログを表示
        cat logs/bot.log
        
        # プロセスが実行中か確認
        if ! ps -p $(cat temp/bot.pid) > /dev/null; then
          echo "ボットの起動に失敗しました"
          cat logs/bot.log
          exit 1
        fi
        
        echo "ボットが正常に起動しました"
        
        # 無限ループで待機
        while true; do
          # ボットがまだ実行中か確認
          if ! ps -p $(cat temp/bot.pid) > /dev/null; then
            echo "ボットが終了しました。再起動します..."
            # 再起動
            export DB_PATH="bot.db"
            nohup python bot.py > logs/bot.log 2>&1 &
            echo $! > temp/bot.pid
            sleep 10
          fi
          # 1分ごとにチェック
          sleep 60
        done

    - name: Show logs
      if: always()
      run: |
        if [ -f logs/bot.log ]; then
          echo "=== 最終ログ ==="
          tail -n 50 logs/bot.log
        fi
